'use client'

import { useEffect, useState } from 'react'
import Link from 'next/link'

interface Agent {
  id: string; name: string; role: string; status: string; avatar_emoji: string
}
interface Task {
  id: string; title: string; status: string; priority: string; assigned_agent_name?: string; assigned_agent_emoji?: string
}
interface BlogPost {
  id: string; title: string; keyword: string; status: string; views: number; published_at: string
}
interface Revenue {
  id: string; source: string; amount: number; date: string
}
interface Event {
  id: string; type: string; description: string; created_at: string; agent_name?: string; agent_emoji?: string
}

export default function CEODashboard() {
  const [agents, setAgents] = useState<Agent[]>([])
  const [tasks, setTasks] = useState<Task[]>([])
  const [events, setEvents] = useState<Event[]>([])
  const [blogPosts, setBlogPosts] = useState<BlogPost[]>([])
  const [revenues, setRevenues] = useState<Revenue[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    Promise.all([
      fetch('/api/agents').then(r => r.json()),
      fetch('/api/tasks').then(r => r.json()),
      fetch('/api/events?limit=10').then(r => r.json()),
      fetch('/api/blog').then(r => r.json()),
      fetch('/api/revenue').then(r => r.json()),
    ]).then(([a, t, e, b, rev]) => {
      setAgents(Array.isArray(a) ? a : [])
      setTasks(Array.isArray(t) ? t : [])
      setEvents(Array.isArray(e) ? e : [])
      setBlogPosts(Array.isArray(b) ? b.slice(0, 5) : [])
      setRevenues(Array.isArray(rev) ? rev.slice(0, 30) : [])
      setLoading(false)
    }).catch(() => setLoading(false))
  }, [])

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96 bg-slate-900">
        <div className="text-slate-50 text-xl">â³ ëŒ€ì‹œë³´ë“œ ë¡œë”©ì¤‘...</div>
      </div>
    )
  }

  const totalTasks = tasks.length
  const doneTasks = tasks.filter(t => t.status === 'done').length
  const inProgressTasks = tasks.filter(t => t.status === 'in_progress').length
  const completionRate = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0
  const publishedPosts = blogPosts.filter(p => p.status === 'published').length
  const now = new Date()
  const thisMonthRevenue = revenues
    .filter(r => { const d = new Date(r.date); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() })
    .reduce((sum, r) => sum + Number(r.amount), 0)

  return (
    <div className="min-h-screen bg-slate-900 p-6">
      {/* KPI Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <KPICard emoji="âœ…" label="ì™„ë£Œìœ¨" value={`${completionRate}%`} sub={`${doneTasks}/${totalTasks} íƒœìŠ¤í¬`} gradient="from-emerald-600 to-emerald-800" />
        <KPICard emoji="ğŸ”¥" label="ì§„í–‰ì¤‘ íƒœìŠ¤í¬" value={String(inProgressTasks)} sub="í˜„ì¬ ì‘ì—…ì¤‘" gradient="from-amber-600 to-orange-800" />
        <KPICard emoji="ğŸ“" label="ë¸”ë¡œê·¸ ë°œí–‰" value={String(publishedPosts)} sub={`ì´ ${blogPosts.length}ê°œ ì¤‘`} gradient="from-blue-600 to-indigo-800" />
        <KPICard emoji="ğŸ’°" label="ì´ë²ˆë‹¬ ë§¤ì¶œ" value={`â‚©${(thisMonthRevenue/1000).toFixed(0)}K`} sub={now.toLocaleDateString('ko-KR', {month:'long'})} gradient="from-violet-600 to-purple-800" />
      </div>

      {/* 2-Column Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Left Column */}
        <div className="space-y-6">
          {/* Agent Status */}
          <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold text-slate-50">ğŸ‘¥ ì—ì´ì „íŠ¸</h2>
              <Link href="/settings" className="text-blue-400 text-xs hover:underline">ì„¤ì • â†’</Link>
            </div>
            <div className="space-y-2">
              {agents.map(agent => (
                <div key={agent.id} className="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">{agent.avatar_emoji || 'ğŸ¤–'}</span>
                    <div>
                      <div className="text-slate-50 font-medium text-sm">{agent.name}</div>
                      <div className="text-slate-400 text-xs">{agent.role}</div>
                    </div>
                  </div>
                  <span className={`px-2 py-1 rounded text-xs text-white ${agent.status === 'active' ? 'bg-green-600' : 'bg-slate-600'}`}>
                    {agent.status === 'active' ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸'}
                  </span>
                </div>
              ))}
              {agents.length === 0 && <div className="text-slate-500 text-sm text-center py-4">ì—ì´ì „íŠ¸ ì—†ìŒ</div>}
            </div>
          </div>

          {/* Task Summary */}
          <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold text-slate-50">ğŸ¯ íƒœìŠ¤í¬ í˜„í™©</h2>
              <Link href="/workspace/default" className="text-blue-400 text-xs hover:underline">ì¹¸ë°˜ â†’</Link>
            </div>
            <div className="space-y-2">
              {(['in_progress', 'inbox', 'testing'] as const).map(status => {
                const filtered = tasks.filter(t => t.status === status)
                if (filtered.length === 0) return null
                return (
                  <div key={status}>
                    <div className="text-slate-400 text-xs uppercase mb-1">{statusLabel(status)} ({filtered.length})</div>
                    {filtered.slice(0, 3).map(t => (
                      <div key={t.id} className="flex items-center gap-2 p-2 bg-slate-700/50 rounded mb-1">
                        <span className="text-sm">{t.assigned_agent_emoji || 'ğŸ“Œ'}</span>
                        <span className="text-slate-300 text-sm truncate flex-1">{t.title}</span>
                        {t.priority === 'P1' && <span className="text-red-400 text-xs font-bold">P1</span>}
                      </div>
                    ))}
                  </div>
                )
              })}
              {tasks.length === 0 && <div className="text-slate-500 text-sm text-center py-4">íƒœìŠ¤í¬ ì—†ìŒ</div>}
            </div>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-6">
          {/* Activity Feed */}
          <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold text-slate-50">ğŸ“‹ ìµœê·¼ í™œë™</h2>
            </div>
            <div className="space-y-2">
              {events.slice(0, 8).map(ev => (
                <div key={ev.id} className="text-sm py-2 border-b border-slate-700 last:border-0">
                  <div className="text-slate-500 text-xs">
                    {new Date(ev.created_at).toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                  </div>
                  <div className="text-slate-300 text-sm truncate">
                    <span className="font-medium">{ev.agent_emoji || 'âš¡'}</span> {ev.description || ev.type}
                  </div>
                </div>
              ))}
              {events.length === 0 && <div className="text-slate-500 text-sm text-center py-4">í™œë™ ì—†ìŒ</div>}
            </div>
          </div>

          {/* Blog */}
          <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold text-slate-50">âœï¸ ìµœê·¼ ë¸”ë¡œê·¸</h2>
              <Link href="/blog" className="text-blue-400 text-xs hover:underline">ë”ë³´ê¸° â†’</Link>
            </div>
            <div className="space-y-2">
              {blogPosts.map(post => (
                <div key={post.id} className="flex justify-between items-center p-3 bg-slate-700/50 rounded-lg">
                  <div className="flex-1 min-w-0">
                    <div className="text-slate-50 text-sm truncate">{post.title}</div>
                    <div className="text-slate-500 text-xs">{post.keyword}</div>
                  </div>
                  <div className="flex items-center gap-2 ml-4">
                    <span className="text-slate-400 text-xs">{post.views || 0}ë·°</span>
                    <span className={`px-2 py-0.5 rounded text-xs text-white ${post.status === 'published' ? 'bg-green-600' : 'bg-slate-600'}`}>
                      {post.status === 'published' ? 'ë°œí–‰' : 'ì„ì‹œ'}
                    </span>
                  </div>
                </div>
              ))}
              {blogPosts.length === 0 && <div className="text-slate-500 text-sm text-center py-4">ë¸”ë¡œê·¸ ì—†ìŒ</div>}
            </div>
          </div>

          {/* Revenue */}
          <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold text-slate-50">ğŸ’° ìµœê·¼ ë§¤ì¶œ</h2>
              <Link href="/revenue" className="text-blue-400 text-xs hover:underline">ë”ë³´ê¸° â†’</Link>
            </div>
            <div className="space-y-2">
              {revenues.slice(0, 5).map(rev => (
                <div key={rev.id} className="flex justify-between items-center p-3 bg-slate-700/50 rounded-lg">
                  <div className="flex items-center gap-2">
                    <span className={`px-2 py-0.5 rounded text-xs text-white ${
                      rev.source === 'adsense' ? 'bg-blue-600' :
                      rev.source === 'kmong' ? 'bg-orange-600' : 'bg-purple-600'
                    }`}>{rev.source}</span>
                    <span className="text-slate-500 text-xs">{rev.date}</span>
                  </div>
                  <span className="text-emerald-400 font-medium text-sm">â‚©{Number(rev.amount).toLocaleString()}</span>
                </div>
              ))}
              {revenues.length === 0 && <div className="text-slate-500 text-sm text-center py-4">ë§¤ì¶œ ë°ì´í„° ì—†ìŒ</div>}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

function KPICard({ emoji, label, value, sub, gradient }: { emoji: string; label: string; value: string; sub: string; gradient: string }) {
  return (
    <div className={`bg-gradient-to-br ${gradient} rounded-xl p-5 shadow-lg`}>
      <div className="flex items-center gap-2 mb-2">
        <span className="text-2xl">{emoji}</span>
        <span className="text-sm text-white/70 font-medium">{label}</span>
      </div>
      <div className="text-3xl font-bold text-white">{value}</div>
      <div className="text-xs text-white/50 mt-1">{sub}</div>
    </div>
  )
}

function statusLabel(s: string): string {
  const m: Record<string, string> = { inbox: 'ëŒ€ê¸°', in_progress: 'ì§„í–‰ì¤‘', testing: 'í…ŒìŠ¤íŠ¸', done: 'ì™„ë£Œ', blocked: 'ì°¨ë‹¨' }
  return m[s] || s
}
